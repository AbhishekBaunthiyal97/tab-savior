<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 Vocal/Instrument Separator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            background-color: white;
            border-radius: 8px;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            display: none;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .downloads {
            margin: 20px 0;
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
        }
        .download-link {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .download-link:hover {
            background-color: #218838;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
        .timing-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>MP3 Vocal/Instrument Separator</h1>
    <div class="container">
        <input type="file" id="fileInput" accept=".mp3" style="display: none;">
        <button onclick="document.getElementById('fileInput').click()">Select MP3 File</button>
        <p id="fileName"></p>
    </div>
    <div class="status" id="status">
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progress"></div>
        </div>
        <p id="status-text"></p>
        <div class="timing-info" id="timing-info"></div>
    </div>
    <div class="downloads" id="downloads">
        <h3>Download Separated Tracks:</h3>
        <div id="downloadLinks"></div>
    </div>

    <script>
        const API_URL = '';
        let statusCheckInterval = null;
        
        async function checkStatus(taskId, maxRetries = 100) {
            let retries = 0;
            
            async function poll() {
                try {
                    const response = await fetch(`${API_URL}/status/${taskId}`);
                    if (!response.ok) {
                        throw new Error('Failed to get status');
                    }
                    
                    const data = await response.json();
                    updateStatus(data);
                    
                    if (data.status === 'completed' || data.status === 'error') {
                        if (statusCheckInterval) {
                            clearInterval(statusCheckInterval);
                        }
                    }
                    
                    retries = 0; // Reset retries on successful request
                } catch (error) {
                    console.error('Error checking status:', error);
                    retries++;
                    
                    if (retries >= maxRetries) {
                        if (statusCheckInterval) {
                            clearInterval(statusCheckInterval);
                        }
                        updateStatus({
                            status: 'error',
                            progress: 0,
                            error: 'Failed to connect to server'
                        });
                    }
                }
            }
            
            // Clear any existing interval
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            // Start polling
            await poll(); // Initial check
            statusCheckInterval = setInterval(poll, 2000); // Check every 2 seconds
        }
        
        function getTrackDisplayName(filename) {
            if (filename.includes('vocals')) return 'Vocals (WAV)';
            if (filename.includes('drums')) return 'Drums (WAV)';
            if (filename.includes('bass')) return 'Bass (WAV)';
            if (filename.includes('other')) return 'Other Instruments (WAV)';
            return 'Unknown Track';
        }
        
        function formatTime(seconds) {
            if (!seconds) return '0s';
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
        }
        
        function updateStatus(data) {
            const statusText = document.getElementById('status-text');
            const progress = document.getElementById('progress');
            const downloads = document.getElementById('downloads');
            
            progress.style.width = `${data.progress}%`;
            statusText.textContent = `${data.status} (${data.progress}%)`;
            
            if (data.error) {
                statusText.textContent = `Error: ${data.error}`;
                return;
            }
            
            if (data.status === 'completed' && data.files) {
                downloads.style.display = 'block';
                const downloadLinks = document.getElementById('downloadLinks');
                downloadLinks.innerHTML = data.files.map(filename => `
                    <a href="${API_URL}/download/${filename}" 
                       class="download-link" 
                       download>
                        Download ${getTrackDisplayName(filename)}
                    </a>
                `).join('');
            }
            
            const timingInfo = document.getElementById('timing-info');
            if (data.timing) {
                const { total_time, steps } = data.timing;
                let timingHtml = `<strong>Processing time:</strong><br>`;
                timingHtml += `Total: ${formatTime(total_time)}<br>`;
                for (const [step, time] of Object.entries(steps)) {
                    timingHtml += `${step}: ${formatTime(time)}<br>`;
                }
                timingInfo.innerHTML = timingHtml;
            } else {
                timingInfo.innerHTML = '';
            }
        }
        
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch(`${API_URL}/upload/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                },
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(error);
            }
            
            return await response.json();
        }
        
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = file.name;
            const status = document.getElementById('status');
            const downloads = document.getElementById('downloads');
            const progress = document.getElementById('progress');
            const statusText = document.getElementById('status-text');
            
            status.style.display = 'block';
            downloads.style.display = 'none';
            progress.style.width = '0%';
            statusText.textContent = 'Uploading...';
            
            try {
                // Upload file
                const uploadResult = await uploadFile(file);
                if (!uploadResult || !uploadResult.filename) {
                    throw new Error('Upload failed');
                }
                
                // Start processing
                const processResp = await fetch(`${API_URL}/process/${uploadResult.filename}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                    },
                });
                
                if (!processResp.ok) {
                    const error = await processResp.text();
                    throw new Error(error);
                }
                
                const { task_id } = await processResp.json();
                
                // Start polling for status
                checkStatus(task_id);
                
            } catch (error) {
                statusText.textContent = `Error: ${error.message}`;
                console.error('Error:', error);
            }
        });
    </script>
</body>
</html> 